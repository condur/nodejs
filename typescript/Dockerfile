FROM node:10.10

# -------------------------------------------------------------------------------------
# Default Environment Variables
# -------------------------------------------------------------------------------------
ENV NODE_ENV production

ENV NODEJS_HOME /opt/typescript
ENV NODEJS_USER typescript

# -------------------------------------------------------------------------------------
# Setup OS
# -------------------------------------------------------------------------------------
RUN set -x \
  && apt-get update \
  && rm -rf /var/lib/apt/lists/*

# -------------------------------------------------------------------------------------
# Create user
# -------------------------------------------------------------------------------------
RUN mkdir -p ${NODEJS_HOME} \
  && useradd -d "${NODEJS_HOME}" -c "NodeJS Typescript User" -s /sbin/nologin "${NODEJS_USER}" \
  && chown --recursive -v ${NODEJS_USER}:${NODEJS_USER} ${NODEJS_HOME}

# -------------------------------------------------------------------------------------
# Set the working directory
# -------------------------------------------------------------------------------------
WORKDIR ${NODEJS_HOME}

# -------------------------------------------------------------------------------------
# Copy the package.json and npm-shrinkwrap.json files and install dependencies
# -------------------------------------------------------------------------------------
COPY package.json npm-shrinkwrap.json ./
RUN npm install

# -------------------------------------------------------------------------------------
# Copy the application files
# -------------------------------------------------------------------------------------
COPY ./bin   ./

# -------------------------------------------------------------------------------------
# Setup application user
# -------------------------------------------------------------------------------------
USER ${NODEJS_USER}

# -------------------------------------------------------------------------------------
# Expose application port number
# -------------------------------------------------------------------------------------
EXPOSE 3000

# -------------------------------------------------------------------------------------
# Launch SCMS Simulator Service
# -------------------------------------------------------------------------------------
CMD ["node", "typescript.app.js"]
